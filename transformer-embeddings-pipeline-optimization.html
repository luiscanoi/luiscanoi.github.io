<!DOCTYPE html>
<html lang="en" class="no-js classic-page-layout " data-audio-wind="audio/wind.mp3" data-audio-wind-reverse="audio/wind-reverse.mp3" data-audio-tick="audio/tick.mp3">
<head>
    
		<meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="Luis Cano, Resume & Portfolio">
        <meta name="keywords" content="vcard, resume, portfolio">
        <meta name="author" content="Luis Cano">
        <meta name="theme-color" content="#1755cf" />

        <title>Luis Cano</title>

        <!-- FAV and TOUCH ICONS -->
        <link rel="shortcut icon" href="images/ico/favicon.ico">
        <link rel="apple-touch-icon" href="images/ico/apple-touch-icon.png">
		 
        <!-- FONTS -->
        <link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Poppins:300,300i,400,400i,600,600i,700,700i" rel="stylesheet">
                         
       
        <!-- STYLES -->
        <link rel="stylesheet" type="text/css" href="css/normalize.css">
        <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
        <link rel="stylesheet" type="text/css" href="js/nprogress/nprogress.css">
        <link rel="stylesheet" type="text/css" href="js/jquery.magnific-popup/magnific-popup.css">
        <link rel="stylesheet" type="text/css" href="css/fonts/fontello/css/fontello.css">
        <link rel="stylesheet" type="text/css" href="css/align.css">
        <link rel="stylesheet" type="text/css" href="css/layout.css">
        <link rel="stylesheet" type="text/css" href="css/main.css">
        <link rel="stylesheet" type="text/css" href="css/768.css">

        
        <!-- INITIAL SCRIPTS -->
<script src="js/jquery-3.2.1.min.js"></script>
    <!-- Replace styles from layout & main with one of the versions found in css/special/stylev# -->
    <link rel="stylesheet" type="text/css" href="css/special/stylev1.css"> 
</head>
    
    
    
	<body>
    	
        
      	
        
        
        
        
        
        
        
          
        
        <!-- PAGE -->
	<div id="page" class="hfeed site">
            
            <!-- .site-main -->
		  	<main id="main" class="site-main cd-main">
          
          
			
            
            
                <!-- HEADER -->
                <header id="masthead" class="header" role="banner">
                    
                    <!-- header-wrap -->
                    <div class="header-wrap layout-full">
                        
                        <img src="images/home/home.jpg" alt="profile-image">

                        <h1 class="site-title">Luis Cano</h1>
                        <p class="site-description">Data Analyst / Analytics Engineering</p>
                        
                        <!-- header-social -->
                        <div class="header-bottom">
                        
                            <a class="social-link linkedin" href="https://www.linkedin.com/in/luis-cano-irigoyen-0624381ba/"></a>
                            <a class="social-link github" href="https://github.com/luiscanoi"></a>
                            <a class="social-link twitter" href="https://x.com/LuisCanoi?s=09"></a>
                            <a class="social-link instagram" href="https://www.instagram.com/luiscano00?igsh=c2Q4YjI4NGVuNmc1"></a>

                        </div>
                        <!-- header-social -->
                        
                        <!-- NAV MENU -->
                        <nav id="primary-navigation" class="site-navigation primary-navigation" role="navigation">
                            <div class="nav-menu menu-with-icons">
                                <ul>
<li><a class="home" href="index.html">Home</a></li>
                                <li><a class="return" href="portfolio.html">Back To All Projects</a></li>
                                <li><a class="search-toggle">Search</a></li>
                    	
                    			</ul>
                            </div>
                        </nav>
                        <!-- NAV MENU -->
                        
                        
                        
                        <!-- SEARCH --> 
                        <div class="header-search">
                            <form role="search" method="get" id="search-form" action="#">
                              <input type="text" value="" name="s" id="search" placeholder="type and hit enter">
                              <input type="submit" id="search-submit" title="Search" value="→">
                            </form>
                        </div>
                        <!-- SEARCH -->
                        
                        
                    </div>
                    <!-- header-wrap -->
                    
                </header>
                <!-- HEADER -->
            
            
            
            
                
                
                <!-- site-middle -->
                <div class="site-middle">
                
                
                
                     
                
                     
                    
                     
                    
                     
                    <div class="layout-fixed"> 
                        <div id="primary" class="content-area">
                    
                    
                     
                    
                     
                
                    
        
                    
                            <!-- site-content -->
                            <div id="content" class="site-content" role="main"> <!-- .blog-single -->
                                <div class="blog-single page-layout">
                                
                                        
                                        <!-- .hentry -->
                                        <article class="post type-post hentry">
                                        
                                        
                                          <!-- .entry-header -->
                                          <header class="entry-header">
                                            <h1 class="entry-title">Transformer Embeddings Pipeline Optimizations</h1>
                                            
                                            <!-- .entry-meta -->
                                            <div class="entry-meta">
                                                <span class="entry-date">
                                                    <time class="entry-date">July 08, 2025</time>
                                                </span> 
                                                <span class="cat-links">
                                                    <a href="#" title="View all posts in Data" rel="category tag">Data</a>
                                                </span>	
                                                <!--<span class="edit-link">
                                                    <a class="post-edit-link" href="#">Edit</a>
                                                </span>-->
                                            </div>
                                            <!-- .entry-meta -->
                                            
                                          </header>
                                          <!-- .entry-header -->
                                          
                                          <!-- .featured-image -->  
                                          <div class="featured-image">
                                            <img src="images/portfolio/bertopic-logo.png" alt="blog-image">
                                          </div>
                                          <!-- .featured-image --> 
                                          
                                          
                                          <!-- .entry-content --> 
                                          <div class="entry-content">
                                                <h2>Scaling Embedding-Based Topic Modeling to Millions of Documents (Without a Huge Machine)</h2>
                                               
                                                <p class="drop-cap">Semantic embeddings changed the game for topic discovery. Instead of relying on brittle keyword overlap or bag-of-words frequency tricks, we can now cluster documents by meaning using sentence transformers, then label clusters into topics that humans can understand and act on.</p>
                                                
                                                <p>But there's a catch: You need a machine powerfull enough to run the pipeline. Of course you can simply buy higher-tier equipment or just pay for additional computing power on a virtual machine, but that's not the point of this posts. Rather how can I run my pipelines without needing to spend more $ using my current setup.</p>

                                                <p>If you've ever tried to run a “standard” transformer embeddings → clustering pipeline at large scale (especially on a laptop or modest VM), youve likely hit some combination of:</p>
                                                <ul>
                                                    <li><p>memory explosions (RAM usage spikes)</p></li>
                                                    <li><p>huge runtime (hours → days)</p></li>
                                                    <li><p>clustering instability or weird fragmentation</p></li>
                                                    <li><p>expensive topic labeling cost (LLM calls)</p></li>
                                                    <li><p>outliers swallowing too much of the dataset</p></li>                                                
                                                </ul>

                                                <p>In this article, I'll walk through a few practical, proven optimizations that made transformer-based topic modeling feasible for me even when working with transformer-based embeddings for millions of documents with a total of 16GB of RAM.</p>

                                                <p>We'll discuss the approach in a general way (applicable to many embedding clustering workflows), and then anchor it using BERTopic, because it's one of the most effective and widely used open-source topic modeling frameworks when you want high-quality semantic clusters (and also as it is what I used when making these optimizations).</p>

                                                <h2>The Issue: Embeddings + Clustering Don't Scale Linearly</h2>

                                                <h4>1) Embeddings take memory (a lot of it)</h4>
                                                <p>If you have N documents and an embedding dimension D, storing embeddings alone costs roughly:</p>
                                                <p>N × D × dtype_size</p>
                                                <p>So for a million documents:</p>
                                                <ul>
                                                  <li><p>D=768, float32 → ~3 GB just for embeddings</p></li>
                                                  <li><p>float64 → ~6 GB (and this mistake happens more often than people think)</p></li>
                                                </ul>
                                                <p><i>(pst, validate the data type in which you are saving them)</i></p>

                                                <h4>2) UMAP / reduction can become the next pain point</h4>
                                                <p>UMAP is powerful for reducing embedding vectors into a lower-dimensional manifold where clustering behaves better.</p>

                                                <p>But it can also become one of the biggest memory/time consumers, especially if you run it naively at large N.</p>

                                                <h4>3) HDBSCAN is great… and also expensive</h4>
                                                <p>HDBSCAN tends to be excellent for topic modeling because it can:</p>
                                                <ul>
                                                  <li><p>discover variable-density cluster</p></li>
                                                  <li><p>mark noise as outliers</p></li>
                                                  <li><p>avoid forcing every document into a cluster</p></li>
                                                </ul>
                                                <p>But it's not “cheap”, and it can struggle when you scale to huge datasets unless you tune it intentionally.</p>

                                                <h4>4) “Topic modeling” isn't finished until humans can read the topics</h4>
                                                <p>Even if clustering is perfect, you still need:</p>
                                                <ul>
                                                  <li><p>topic representations (labels)</p></li>
                                                  <li><p>representative documents per topic</p></li>
                                                  <li><p>summaries that a downstream system (or stakeholder) can interpret</p></li>
                                                </ul>
                                                <p>If you involve LLMs for naming topics, cost and latency can spike quickly.</p>

                                                <h2>BERTopic as the baseline</h2>
                                                <p>A BERTopic topic modeling pipeline uses a combination of:</p>
                                                <ul>
                                                  <li><p>transformer embeddings</p></li>
                                                  <li><p>dimensionality reduction (typically UMAP)</p></li>
                                                  <li><p>density clustering (typically HDBSCAN)</p></li>
                                                  <li><p>topic representation / labeling (typically c-TF-IDF)</p></li>
                                                </ul>
                                                <p>You can read more about it in the <a href="https://maartengr.github.io/BERTopic/getting_started/clustering/clustering.html" target="_blank">documentation.</a></p>

                                                <h3>A Standard BERTopic Pipeline</h3>
                                                <p>Very basic implementation:</p>
                                                <code>from bertopic import BERTopic
from sentence_transformers import SentenceTransformer
from umap import UMAP
from hdbscan import HDBSCAN

embed_model = SentenceTransformer("all-mpnet-base-v2")
umap_model = UMAP(n_neighbors=15, n_components=5, metric="cosine")
hdbscan_model = HDBSCAN(min_cluster_size=15, metric="euclidean")

topic_model = BERTopic(
  embedding_model=embed_model,
  umap_model=umap_model,
  hdbscan_model=hdbscan_model
)
topics, probs = topic_model.fit_transform(docs)
</code>

                                                <p>Without attempting it I can tell you right now that my laptop would not be able to run 2M+ documents though these steps; but that's where we start talking about optimizations!</p>

                                                <h3>1. Make Embeddings Cheaper (without killing quality)</h3>
                                                <p>Use smaller embedding models where possible:</p>
                                                <ul>
                                                  <li><p>e.g. SentenceTransformer("all-MiniLM-L6-v2") instead of "all-mpnet-base-v2"</p></li>
                                                </ul>
                                                <p>Cap embeddings sequence length:</p>
                                                <ul>
                                                  <li><p>max_seq_length = 256</p></li>
                                                </ul>
                                                <p>Precompute embeddings explicitly:</p>
                                                <ul>
                                                  <li><p>convert_to_numpy=True</p></li>
                                                  <li><p>convert_to_tensor=False</p></li>
                                                  <li><p>normalize_embeddings=True</p></li>
                                                  <li><p>cast to float32</p></li>
                                                </ul>
                                                <p><i>Mackbook/MPS note, set torch.mps.empty_cache()</i></p>

                                                <h3>2. Reduce Embedding Dimensionality Before Clustering (IncrementalPCA)</h3>
                                                <p>There are other functions that achieve a similar result, in my case I went for IncrementalPCA:</p>
                                                <code>IncrementalPCA(n_components=target_components, batch_size=8192)</code>
                                                <p>Normalize embeddings again after PCA for cosine-friendly geometry.</p>

                                                <h3>3. The Big Optimization – Coreset Fitting (fit small, then assign all)</h3>
                                                <p>Instead of fitting BERTopic on all documents:</p>
                                                <ol>
                                                  <li><p>select a representative coreset</p></li>
                                                  <li><p>fit BERTopic on the coreset (all cluster groups are created here)</p></li>
                                                  <li><p>assign remaining documents (mapped to the already created groups)</p></li>
                                                </ol>
                                                <p>This would look like:</p>
                                                <code>[...apply coreset selection logic, split core & rest, then...]
# Fit BERTopic model on coreset only
topics_core, probs_core = topic_model.fit_transform(docs_core, embed_core)

# Now transform the remainder of documents - note we now use .transform()
topics_rest, probs_rest = topic_model.transform(docs_rest, embed_rest)

topics_full = np.full(embeddings.shape[0], fill_value=-1, dtype=int)
probs_full = np.full(embeddings.shape[0], fill_value=np.nan, dtype=float)
</code>
                                                <p>After fitting, we stitch the outputs back into full topic arrays.</p>
                                                <p>For coreset selection we used MiniBatchKMeans with K=10,000 to cover niche modes. The gist is that if the coreset correctly represents the full dataset, then BERTopic should be able to identify all the correct groups just from the coreset, saving huge amounts in memory, and then the .transform() for the remainder is just basic mapping done by the models.</p>

                                                <p>In our case where we were running with 2M+ total documents, we made a coreset of 500k documents which represented majority of all the data including niche topics. I.e. we were able to run the fit_transform() of BERTopic on less than 1/4 of the total documents!</p>

                                                <h3>4. UMAP + HDBSCAN tunning for scale</h3>
                                                <p>UMAP low-memory settings:</p>
                                                <ul>
                                                  <li><p>low_memory=True</p></li>
                                                  <li><p>force_approximation_algorithm=True</p></li>
                                                </ul>

                                                <p>HDBSCAN configured to use .transform():</p>
                                                <ul>
                                                  <li>rediction_data=True</li>
                                                </ul>

                                                <p>And always consider using ore aggressive topic sizes to reduce fragmentation: min_cluster_size, min_samples and cluster_selection_method.</p>

                                                <h3>5. Post-clustering cleanup</h3>
                                                <p>BERTopic pipeline by default does not apply min probability cuttoffs. So withing a topic group you can have documents belonging with abysmal probabilities. Use the probabilities that the model fitting step returns to apply an appropriate threshold, the documents that should not belong to their topic group can be moved to outliers: if prob < threshold → topic_id = -1.</p>

                                                <p>Important clarification: calculate_probabilities parameter from BERTopic model.</p>
                                                <code>topic_model = BERTopic(
    [...],
    calculate_probabilities=False
)</code>
                                                <ul>
                                                  <li><p>calculate_probabilities=True computes the full doc-to-all-topics probability matrix (useful when building a Graph)</p></li>
                                                  <li><p> calculate_probabilities=False avoids that full matrix</p></li>
                                                  <li><p>BERTopic still provides the probability to the assigned topic (the prob value that we were using above), even when calculate_probabilities=False</p></li>
                                                </ul>

                                                <h3>6. Cut Topic Labeling Costs</h3>
                                                <p>If you are more familiar with BERTopic you may have seen that it can use OpenAI for topic representations (topic labels):</p>
                                                <code>from bertopic.representation import OpenAI
openai_generator = OpenAI(
  [...]
)
topic_model = BERTopic(
  representation_model=openai_generator,
  [...]
)
topic_model.fit_transform([...])
</code>

                                                <p>This is a step where we identified a requests reduction optimization, as we were not keeping all of the topic groups after applying deduplications and fitlering criteria. Thus we found the following approach more effective:</p>
                                                <ol>
                                                  <li><p>first use cheap representations, e.g. representation_model=KeyBERTInspired(nr_repr_docs=20)</p></li>
                                                  <li><p>run the topic modeling .fit_transform()</p></li>
                                                  <li><p>run the remainder of the process, including the topics filtering, until we have the final topics we know we will keep</p></li>
                                                  <li><p>now you can use the topic_model.update_topics() function to update the representations with LLM labels only for the filtered topics:</p></li>
                                                </ol>
                                                <code>topic_model.update_topics(
  docs=filtered_docs,
  topics=fitlered_topics,
  representation_model=openai_generator
)
</code>
                                                <h2>In Conclusion</h2>
                                                <p>Embedding-based topic modeling is powerful, but without optimization it becomes too slow, too memory hungry, and too expensive. Thankfully there are a lot of optimizations that we can do to improve the process, it's up to you to determine which of them to implement.</p>
                                          
                                              <!-- .entry-meta -->
                                              <footer class="entry-meta tags">
                                                <a href="#" rel="tag">data</a> <a href="#" rel="tag">python</a> <a href="#" rel="tag">ai/ml</a>
                                              </footer>
                                              <!-- .entry-meta -->
                                            
                                            
                                            
                                          </div>
                                          <!-- .entry-content -->
                                          
                                          
                                        
                                        
                                        
                                        
                                        <!-- .nav-single -->
                                        <nav class="nav-single row">
                                        
                                            <div class="nav-previous col-sm-6">
                                                <h6>PREVIOUS POST</h6>
                                                <h5><a href="projects/SentimentAnalysisCoLSTM-es.pdf" rel="prev"><span class="meta-nav">←</span>Sentiment Analysis CoLSTM</a></h5>
                                            </div>
                                            
                                            <div class="nav-next col-sm-6">
                                                <h6>NEXT POST</h6>
                                                <h5><a href="reddit-trends-extraction.html" rel="next">Transformer Embeddings Pipeline Optimizations<span class="meta-nav">→</span></a></h5>
                                            </div>
                                            
                                        </nav>
                                        <!-- .nav-single --> 
                                        
                                        
                                        

                                          
                                          
                                          <!-- #respond --> 
                                          <div id="respond">
                                          
                                            <h3 id="reply-title">Leave a comment <small><a rel="nofollow" id="cancel-comment-reply-link" href="#" style="display:none;">Cancel reply</a></small></h3>
                                            
                                            <!-- .commentform -->
                                            <form action="#" method="post" id="commentform">
                                            
                                              <p class="comment-notes">Your email address will not be published. Required fields are marked <span class="required">*</span></p>
                                              
                                              <p class="comment-form-comment">
                                                <label for="comment">Comment</label>
                                                <textarea id="comment" name="comment" rows="8" aria-required="true"></textarea>
                                              </p>
                                              
                                              <p class="comment-form-author">
                                                <label for="author">Name <span class="required">*</span></label>
                                                <input id="author" name="author" type="text" size="30" aria-required="true">
                                              </p>
                                              
                                              <p class="comment-form-email">
                                                <label for="email">Email <span class="required">*</span></label>
                                                <input id="email" name="email" type="text" size="30" aria-required="true">
                                              </p>
                                              
                                              
                                              <p class="form-allowed-tags">You may use these <abbr title="HyperText Markup Language">HTML</abbr> tags and attributes: <code>&lt;a href="" title=""&gt; &lt;abbr title=""&gt; &lt;acronym title=""&gt; &lt;b&gt; &lt;blockquote cite=""&gt; &lt;cite&gt; &lt;code&gt; &lt;del datetime=""&gt; &lt;em&gt; &lt;i&gt; &lt;q cite=""&gt; &lt;strike&gt; &lt;strong&gt; </code></p>
                                              
                                              <p class="form-submit">
                                                <input type="submit" class="button primary" value="Post Comment">
                                              </p>
                                              
                                            </form>
                                            <!-- .commentform -->
                                            
                                          </div>
                                          <!-- #respond --> 
                                          
                                        </div>
                                        <!-- #comments -->
                
                
                                </div>
                                <!-- .blog-single --> 
                
                
                </div>
                            <!-- site-content -->
                    
                        </div>
                        <!-- primary -->    
                    
                    
                        
                    
                    
                    </div>
                    <!-- layout -->
                
                
                </div>
                <!-- site-middle -->
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    <!-- .site-footer -->
                    <footer id="colophon" class="site-footer" role="contentinfo">
                        
                        <!-- .site-info --> 
                        <div class="site-info">
                            <div class="textwidget">
                                <p><p>&copy; 2025</p></p>
                            </div>
                        </div>
                        <!-- .site-info --> 
                        
                    </footer>
                    <!-- .site-footer --> 
    
                
                
                    
        </main>
                <!-- .site-main -->
                
                



                <!-- ALERT : used for contact form mail delivery alert -->
                <div class="site-alert animated"></div>
                
                
                
                
            </div>
            <!-- PAGE -->
        
        
        
        
        <!-- SCRIPTS -->
		<script src="js/fastclick.js"></script>
        <script src="js/jquery.address.js"></script>
        <script src="js/nprogress/nprogress.js"></script>
        <script src="js/jquery.isotope.min.js"></script>
        <script src="js/imagesloaded.pkgd.min.js"></script>
        <script src="js/jquery.fitvids.js"></script>
        <script src="js/jquery.magnific-popup/jquery.magnific-popup.min.js"></script>
        <script src="js/jquery.easing.1.3.js"></script>
        <script src="js/jquery.validate.min.js"></script>

        
		<!-- <script src="https://maps.googleapis.com/maps/api/js"></script> -->
      	<!-- 
            Uncomment the script code above
            
        	Get Google Map Api Key
        	https://developers.google.com/maps/documentation/javascript/get-api-key
            
            Get your google map api key and uncomment the script code below and paste your api key.
        --> 
        <!--<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY_HERE"></script>-->
        
        <script src="js/main.js"></script>
        
	</body>
</html>